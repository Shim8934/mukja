<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace속성:매퍼파일의 완전한경로.xml는 생략 -->
<!-- ※ ibatis와는 다르게 id값에 .(dot)을 사용 못한다 -->
<mapper namespace="mybatis.StoreDetail">

	<select id="getStoreDetailInfo" parameterType="java.util.Map" resultType="storeDTO">
     select * from Stores s join foodmenu f on s.username = f.username where s.username = #{username}
    </select>
    
 	 <select id="getReviewCount" parameterType="java.util.Map" resultType="int">
    	 select count(*) from storereview where store_name = #{username}
    </select>
 	 <select id="getFoodMenu" parameterType="java.util.Map" resultType="foodMenuDTO">
    	 select * from foodmenu where username = #{username}
    </select>
    
     <select id="getStoreIMG" parameterType="java.util.Map" resultType="storeIMGDTO">
    	 select * from store_file where username = #{username}
    </select>
    
     <select id="getFoodIMG" parameterType="java.lang.String" resultType="foodIMGDTO">
    	 select * from fm_file where menu_no = #{menu_no}
    </select>
    
    <update id="updateStoreAvg" parameterType="java.util.Map">
    	update store_avg set sa_avg=#{starCount} where  store_id=#{store_id} and user_id=#{user_id}
    </update>
    
    <insert id="insertStoreAvg"  parameterType="java.util.Map">
    	insert into store_avg values(SEQ_SA.nextval,#{store_id},#{starCount},#{user_id})
    </insert>
    
    <select id="selectAvg" parameterType="java.util.Map" resultType="int">
    	select count(*) from store_avg where store_id=#{store_id} and user_id=#{user_id}
    </select>
     <select id="getStoreAvg" parameterType="java.util.Map" resultType="float">
    	select avg(sa_avg) from store_avg where store_id=#{username}
    </select>
    
     <select id="selectThumb" parameterType="java.util.Map" resultType="int">
    	select count(*) from store_thumb where store_id=#{store_id} and user_id=#{user_id}
    </select>
    
	<delete id="deleteThumb" parameterType="java.util.Map">
    	delete store_thumb where store_id=#{store_id} and user_id=#{user_id}
    </delete>
    
    <insert id="insertThumb"  parameterType="java.util.Map">
    	insert into store_thumb values(SEQ_thumb.nextval,#{store_id},#{user_id})
    </insert>
    
     <select id="getStoreThumb" parameterType="java.util.Map" resultType="int">
    	select count(*) from store_thumb where store_id=#{username}
    </select>
        <select id="isThumb" parameterType="java.util.Map" resultType="int">
    	select count(*) from store_thumb where store_id=#{username} and user_id=#{user_id}
    </select>
    
    <select id="selectFoodImg" parameterType="java.util.Map" resultType="storeDTO">
    	select fm.*,ff.fm_path from foodmenu fm join fm_file ff on fm.menu_no = ff.menu_no where fm.username = #{username}
    </select>
    
    
    <!-- 리뷰 쓰기 -->
    <insert id="insertSTreview" parameterType="java.util.Map">
     	insert into storereview values(SEQ_STOREREVIEW.nextval,'default_title',#{rv_content},sysdate,#{user_id},#{username},1)
    </insert>
    <update id="UpdateReview" parameterType="java.util.Map">
     	update storereview set (rv_title=#{rv_title}, rv_content={rv_content}) where rv_no=#{rv_no}
    </update>
    
    <!-- 리뷰 가져오기-->
    
    <select id="getStoreReview" parameterType="java.util.Map" resultType="MyPageDTO">
		SELECT * FROM storereview WHERE store_name=#{username} order by rv_postdate desc
	</select>
	<select id="getStRvTotal" parameterType="java.util.Map" resultType="int">
		SELECT count(*) FROM storereview WHERE store_name = #{username}
	</select>	
	
	<select id="getStoreReviewcnt" parameterType="java.util.Map" resultType="MyPageDTO">
		SELECT * FROM (SELECT T.*,ROWNUM R FROM (SELECT * FROM storereview WHERE store_name=#{username} order by rv_postdate desc)T)where R between #{strvstart} AND #{strvend}	
	</select>
	<select id="getStoreReviewimg" parameterType="java.util.Map" resultType="MyPageDTO">
		SELECT * FROM review_file 		
	</select>	
	<select id="getUsersNicks" parameterType="java.util.Map" resultType="UsersDTO">
		SELECT u_nick,username,u_img FROM users
	</select>
	
	<select id="getBrv" parameterType="java.util.Map" resultType="UsersDTO">
		select * from review_thumb
	</select>
    
    <!-- 가게 정보 수정 -->
    <update id="updateStoreInfo" parameterType="java.util.Map">
    	update stores set password = #{password}, store_addr = #{store_addr}, store_phnum = #{store_phnum}, store_email = #{store_email}, store_time = #{store_time}, store_lat = #{store_lat}, store_lng = #{store_lng}, store_intro = #{store_intro} where username = #{username}
    </update>
    <update id="updateStoreImg" parameterType="java.util.Map">
    	update store_file set sf_path = #{sf_path} where sf_no = #{sf_no}
    </update>
    <insert id="insertStoreImg" parameterType="java.util.Map">
    	insert into store_file values(SEQ_SF.nextval,#{username},#{sf_path})
    </insert>
</mapper>